---
name: Tox Full Test Suite

'on':
  workflow_dispatch:
    inputs:
      python_versions:
        description: 'Python versions to test (comma-separated)'
        required: false
        default: '3.11,3.12,3.13'
      tox_environments:
        description: 'Additional tox environments to run'
        required: false
        default: 'lint,format,docs'
      upload_coverage:
        description: 'Upload coverage reports'
        type: boolean
        required: false
        default: true
  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'tox.ini'
      - 'pyproject.toml'
      - '.github/workflows/tox-full-suite.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'tox.ini'
      - 'pyproject.toml'
      - '.github/workflows/tox-full-suite.yml'

env:
  # Test environment variables
  HH_API_KEY: test-api-key-12345
  HH_API_URL: https://api.honeyhive.ai
  HH_PROJECT: test-project
  HH_SOURCE: github-actions
  HH_TEST_MODE: true
  HH_DEBUG_MODE: true
  HH_DISABLE_TRACING: false
  HH_DISABLE_HTTP_TRACING: false
  HH_OTLP_ENABLED: false

jobs:
  tox-testing:
    name: ðŸ§ª Tox Testing
    runs-on: ubuntu-latest
    outputs:
      matrix-results: ${{ steps.matrix-results.outputs.results }}
    steps:
      - name: Setup Tox Test Matrix
        id: matrix-results
        run: |
          echo "results=success" >> $GITHUB_OUTPUT
          echo "âœ… Tox Test Matrix Initialized"

  # === PYTHON VERSION MATRIX (Full Test Suite) ===
  python-matrix:
    name: "  â”œâ”€ ðŸ Python ${{ matrix.python-version }}"
    needs: tox-testing
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install tox and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0 tox-gh-actions

      - name: Run comprehensive test suite
        run: |
          tox -e py${{ matrix.python-version == '3.11' && '311' || matrix.python-version == '3.12' && '312' || '313' }}
        env:
          HH_API_KEY: ${{ secrets.HH_API_KEY || env.HH_API_KEY }}
          HH_PROJECT: ${{ secrets.HH_PROJECT || env.HH_PROJECT }}

      - name: Upload coverage reports
        if: inputs.upload_coverage != false
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: |
            .coverage
            coverage.xml
            .tox/*/log/
          retention-days: 7

  # === CODE QUALITY CHECKS ===
  code-quality:
    name: "  â”œâ”€ ðŸ” Code Quality"
    needs: tox-testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install tox and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0

      - name: Run linting checks
        run: tox -e lint

      - name: Run format checks
        run: tox -e format

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-results
          path: |
            .tox/lint/log/
            .tox/format/log/
          retention-days: 7

  # === DOCUMENTATION BUILD ===
  documentation:
    name: "  â”œâ”€ ðŸ“š Documentation"
    needs: tox-testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install tox and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0

      - name: Build documentation
        run: tox -e docs

      - name: Upload documentation build
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: docs/_build/html/
          retention-days: 14

  # === INTEGRATION TESTS (Real API) ===
  integration-tests:
    name: "  â”œâ”€ ðŸ”— Integration Tests"
    needs: tox-testing
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install tox and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0

      - name: Run integration tests with real API
        env:
          HH_API_KEY: ${{ secrets.HH_API_KEY }}
          HH_PROJECT: ${{ secrets.HH_PROJECT }}
          HH_SOURCE: "github-actions-integration"
        run: tox -e integration

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .coverage
            coverage.xml
            .tox/integration/log/
          retention-days: 7

  # === TEST SUITE SUMMARY ===
  summary:
    name: "  â”œâ”€ ðŸ“Š Test Summary"
    needs: [tox-testing, python-matrix, code-quality, documentation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate test summary
        run: |
          echo "# ðŸ§ª Tox Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Version Results
          echo "## ðŸ Python Version Testing" >> $GITHUB_STEP_SUMMARY
          python_result="${{ needs.python-matrix.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- **Python 3.11:** $python_result" >> $GITHUB_STEP_SUMMARY
          echo "- **Python 3.12:** $python_result" >> $GITHUB_STEP_SUMMARY
          echo "- **Python 3.13:** $python_result" >> $GITHUB_STEP_SUMMARY

          # Quality Checks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Quality Checks" >> $GITHUB_STEP_SUMMARY
          quality_result="${{ needs.code-quality.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          docs_result="${{ needs.documentation.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- **Code Quality:** $quality_result" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation:** $docs_result" >> $GITHUB_STEP_SUMMARY

          # Overall Status
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.python-matrix.result }}" = "success" ] && \
             [ "${{ needs.code-quality.result }}" = "success" ] && \
             [ "${{ needs.documentation.result }}" = "success" ]; then
            echo "## ðŸŽ‰ **ALL TESTS PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "The full tox test suite completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ **TESTS FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Some tests failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi

  # === OPTIONAL: FULL TOX SUITE (Sequential) ===
  tox-full-sequential:
    name: "  â””â”€ ðŸŽ¯ Sequential Suite"
    needs: tox-testing
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install tox and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0

      - name: Run full tox suite sequentially
        run: |
          echo "Running full tox suite for comparison..."
          tox
