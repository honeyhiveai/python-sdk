---
name: Tox Full Test Suite

'on':
  workflow_dispatch:
    inputs:
      python_versions:
        description: 'Python versions to test (comma-separated)'
        required: false
        default: '3.11,3.12,3.13'
      tox_environments:
        description: 'Additional tox environments to run'
        required: false
        default: 'lint,format,docs,unit,integration'
      upload_coverage:
        description: 'Upload coverage reports'
        type: boolean
        required: false
        default: true
  push:
    branches: [main, complete-refactor]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'tox.ini'
      - 'pyproject.toml'
      - '.github/workflows/tox-full-suite.yml'
  pull_request:
    branches: [main, complete-refactor]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'tox.ini'
      - 'pyproject.toml'
      - '.github/workflows/tox-full-suite.yml'

env:
  # Test environment variables
  HH_API_KEY: test-api-key-12345
  HH_API_URL: https://api.honeyhive.ai
  HH_PROJECT: test-project
  HH_SOURCE: github-actions
  HH_TEST_MODE: true
  HH_DEBUG_MODE: true
  HH_DISABLE_TRACING: false
  HH_DISABLE_HTTP_TRACING: false
  HH_OTLP_ENABLED: false

jobs:
  tox-matrix:
    name: Tox Matrix Testing
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
        tox-env:
          - py311
          - py312
          - py313
          - unit
          - integration
        exclude:
          # Only run Python version-specific envs on matching Python versions
          - python-version: '3.11'
            tox-env: py312
          - python-version: '3.11'
            tox-env: py313
          - python-version: '3.12'
            tox-env: py311
          - python-version: '3.12'
            tox-env: py313
          - python-version: '3.13'
            tox-env: py311
          - python-version: '3.13'
            tox-env: py312
          # Run unit/integration tests only on Python 3.12 to avoid duplication
          - python-version: '3.11'
            tox-env: unit
          - python-version: '3.11'
            tox-env: integration
          - python-version: '3.13'
            tox-env: unit
          - python-version: '3.13'
            tox-env: integration

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Set up virtual environment (following project standards)
        run: |
          python -m venv python-sdk
          source python-sdk/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0 tox-gh-actions
          pip install -e .

      - name: Run tox environment - ${{ matrix.tox-env }}
        run: |
          tox -e ${{ matrix.tox-env }}

      - name: Upload coverage reports
        if: >
          matrix.tox-env == 'unit' || matrix.tox-env == 'integration' ||
          startsWith(matrix.tox-env, 'py')
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: ${{ matrix.tox-env }}
          name: >
            codecov-${{ matrix.tox-env }}-py${{ matrix.python-version }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: >
            test-results-${{ matrix.tox-env }}-py${{ matrix.python-version }}
          path: |
            .coverage
            coverage.xml
            .tox/*/log/
          retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up virtual environment
        run: |
          python -m venv python-sdk
          source python-sdk/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0
          pip install -e .

      - name: Run linting checks
        run: |
          tox -e lint

      - name: Run format checks
        run: |
          tox -e format

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-results
          path: |
            .tox/lint/log/
            .tox/format/log/
          retention-days: 7

  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up virtual environment
        run: |
          python -m venv python-sdk
          source python-sdk/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0
          pip install -e .

      - name: Build documentation
        run: |
          tox -e docs

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: docs/_build/html/
          retention-days: 14

  integration-tests:
    name: Integration Tests (Real API)
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up virtual environment
        run: |
          python -m venv python-sdk
          source python-sdk/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0
          pip install -e .

      - name: Run integration tests
        env:
          HH_API_KEY: ${{ secrets.HH_API_KEY || 'test-api-key-12345' }}
          HH_PROJECT: ${{ secrets.HH_PROJECT || 'test-project' }}
          HH_TEST_MODE: false
        run: |
          tox -e integration

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .coverage
            coverage.xml
            .tox/integration/log/
          retention-days: 7

  summary:
    name: Test Suite Summary
    runs-on: ubuntu-latest
    needs: [tox-matrix, code-quality, documentation]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate test summary
        run: |
          echo "# Tox Full Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check matrix job results
          if [ "${{ needs.tox-matrix.result }}" == "success" ]; then
            echo "✅ **Matrix Tests**: All Python versions and environments passed" >> \
            $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Matrix Tests**: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Check code quality results
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "✅ **Code Quality**: Linting and formatting checks passed" >> \
            $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Code Quality**: Linting or formatting issues found" >> \
            $GITHUB_STEP_SUMMARY
          fi

          # Check documentation results
          if [ "${{ needs.documentation.result }}" == "success" ]; then
            echo "✅ **Documentation**: Build completed successfully" >> \
            $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Documentation**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Environment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Versions**: 3.11, 3.12, 3.13" >> $GITHUB_STEP_SUMMARY
          echo "- **Tox Environments**: py311, py312, py313, unit, integration, lint, format, docs" >> \
            $GITHUB_STEP_SUMMARY
          echo "- **Coverage Reporting**: Enabled with Codecov" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Retention**: 7-14 days" >> $GITHUB_STEP_SUMMARY

      - name: Report workflow status
        if: failure()
        run: |
          echo "❌ Tox Full Test Suite encountered failures. Check individual job logs for details." >> \
            $GITHUB_STEP_SUMMARY
          exit 1

  # Optional: Run full tox suite in a single environment for comparison
  tox-full-sequential:
    name: Full Tox Suite (Sequential)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up virtual environment
        run: |
          python -m venv python-sdk
          source python-sdk/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox>=4.0
          pip install -e .

      - name: Run full tox suite
        run: |
          tox

      - name: Upload full suite results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-tox-suite-results
          path: |
            .tox/*/log/
            .coverage
            coverage.xml
          retention-days: 14
