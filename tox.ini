[tox]
envlist = py311, py312, py313, lint, format, docs, integration, unit
isolated_build = True
requires = tox>=4.0

[testenv]
deps =
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.0.0
    httpx>=0.24.0
    opentelemetry-api>=1.20.0
    opentelemetry-sdk>=1.20.0
    opentelemetry-exporter-otlp-proto-http>=1.20.0
    wrapt>=1.14.0
    pydantic>=2.0.0
    python-dotenv>=1.0.0

commands =
    pytest tests/unit/test_utils.py -v --asyncio-mode=auto
    pytest tests/unit/test_client.py -v --asyncio-mode=auto
    pytest tests/unit/test_tracer.py -v --asyncio-mode=auto
    pytest tests/unit/test_api.py -v --asyncio-mode=auto
    pytest tests/unit/test_evaluation.py -v --asyncio-mode=auto
    pytest tests/unit/test_http_instrumentation.py -v --asyncio-mode=auto
    pytest tests/unit/test_advanced_features.py -v --asyncio-mode=auto
    pytest tests/unit/test_cli.py -v --asyncio-mode=auto
    pytest tests/ -v --asyncio-mode=auto --cov=honeyhive --cov-report=term-missing

setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_API_KEY = test-api-key-12345
    HH_API_URL = https://api.honeyhive.ai
    HH_PROJECT = test-project
    HH_SOURCE = test
    HH_DEBUG_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
    HH_TEST_MODE = true

passenv =
    HH_API_KEY
    HH_API_URL
    HH_PROJECT
    HH_SOURCE
    HH_TEST_MODE
    HH_DEBUG_MODE
    HH_DISABLE_TRACING
    HH_DISABLE_HTTP_TRACING
    HH_OTLP_ENABLED
    HH_OTLP_ENDPOINT
    HH_OTLP_HEADERS

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

[testenv:py313]
basepython = python3.13

[testenv:lint]
description = run linting checks
deps =
    pylint==3.2.3
    mypy==1.10.1
    types-python-dateutil>=2.9.0.20240316
    types-requests>=2.31.0
    types-urllib3>=1.26.0
    httpx>=0.27.0
    pydantic>=2.10.0
    opentelemetry-api>=1.21.0
    opentelemetry-sdk>=1.21.0
    opentelemetry-exporter-otlp-proto-http>=1.21.0
    opentelemetry-instrumentation>=0.42b0
    wrapt>=1.16.0
    python-dateutil>=2.8.2
    typing-inspect>=0.9.0
    requests>=2.25.1
    dataclasses-json>=0.6.7
    jsonpath-python>=1.0.6
    uplink>=0.1.0
    eval-type-backport>=0.2.0
commands =
    pylint src/honeyhive tests --rcfile=pyproject.toml
    mypy src/honeyhive --config-file=pyproject.toml
setenv =
    PYTHONPATH = {toxinidir}/src
passenv = {[testenv]passenv}

[testenv:format]
description = check code formatting
deps =
    black>=23.0.0
    isort>=5.12.0
commands =
    black --check src tests
    isort --check-only src tests

[testenv:docs]
description = build documentation
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=1.3.0
    myst-parser>=2.0.0
commands =
    sphinx-build -b html docs docs/_build/html

[testenv:integration]
description = run integration tests with REAL API credentials
deps = {[testenv]deps}
commands =
    pytest {posargs:tests/integration} --cov=src/honeyhive --cov-report=term-missing
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_TEST_MODE = false
    HH_DEBUG_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
passenv = 
    {[testenv]passenv}
    HH_API_KEY
    HH_API_URL
    HH_PROJECT
    HH_PROJECT_ID
    HH_SOURCE

[testenv:unit]
description = run unit tests only
deps = {[testenv]deps}
commands =
    pytest {posargs:tests/unit} --cov=src/honeyhive --cov-report=term-missing
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_TEST_MODE = true
    HH_DEBUG_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
passenv = 
    {[testenv]passenv}
    HH_API_KEY
    HH_API_URL
    HH_PROJECT
    HH_PROJECT_ID
    HH_SOURCE
