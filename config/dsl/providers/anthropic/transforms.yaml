version: '1.0'
provider: anthropic
dsl_type: provider_transforms

# Anthropic Transform Functions for Universal LLM Discovery Engine v4.0
# This file defines data transformation functions used during Anthropic field mapping
# Updated for 2025-09-29 with current Claude model support and pricing

transforms:
  
  # === STRING EXTRACTION TRANSFORMS ===
  extract_user_prompt:
    function_type: "string_extraction"
    implementation: "extract_message_content_by_role"
    parameters:
      source_field: "chat_history"
      role_filter: "user"
      content_field: "content"
      join_multiple: true
      separator: "\n\n"
    description: "Extract user prompt from chat history"
    
  extract_system_prompt:
    function_type: "string_extraction"
    implementation: "extract_message_content_by_role"
    parameters:
      source_field: "chat_history"
      role_filter: "system"
      content_field: "content"
      join_multiple: true
      separator: "\n\n"
    description: "Extract system prompt from chat history"
    
  extract_completion_text:
    function_type: "string_extraction"
    implementation: "extract_message_content_by_role"
    parameters:
      source_field: "response"
      role_filter: "assistant"
      content_field: "content"
      join_multiple: true
      separator: "\n\n"
    description: "Extract completion text from response messages"
    
  extract_finish_reason_normalized:
    function_type: "string_extraction"
    implementation: "normalize_finish_reason"
    parameters:
      reason_mappings:
        "end_turn": "stop"
        "max_tokens": "length"
        "tool_use": "tool_calls"
        "stop_sequence": "stop"
      valid_reasons: ["stop", "length", "tool_calls", "content_filter"]
    description: "Extract and normalize Anthropic finish reason"
    
  extract_latency:
    function_type: "numeric_extraction"
    implementation: "extract_duration"
    parameters:
      duration_field: "duration"
      unit: "milliseconds"
    description: "Extract response latency"
    
  extract_request_id:
    function_type: "string_extraction"
    implementation: "extract_request_identifier"
    parameters:
      id_field: "request_id"
    description: "Extract provider request ID"

  # === ARRAY TRANSFORMATION TRANSFORMS ===
  extract_tool_calls:
    function_type: "array_transformation"
    implementation: "extract_field_values_from_messages"
    parameters:
      source_field: "response"
      message_role_filter: "assistant"
      target_field: "tool_calls"
      preserve_structure: true
    description: "Extract tool call information from assistant messages"

  # === NUMERIC CALCULATION TRANSFORMS ===
  calculate_total_tokens:
    function_type: "numeric_calculation"
    implementation: "sum_fields"
    parameters:
      source_fields:
        - "prompt_tokens"
        - "completion_tokens"
      fallback_value: 0
    description: "Calculate total token usage"
    
  calculate_cost:
    function_type: "numeric_calculation"
    implementation: "calculate_anthropic_cost"
    parameters:
      model_field: "model"
      prompt_tokens_field: "prompt_tokens"
      completion_tokens_field: "completion_tokens"
      # Updated pricing as of 2025-09-29
      pricing_table:
        # Claude 3.5 models (current flagship)
        "claude-3-5-sonnet-20241022": {"input": 0.003, "output": 0.015}
        "claude-3-5-sonnet-20240620": {"input": 0.003, "output": 0.015}
        "claude-3-5-haiku-20241022": {"input": 0.0008, "output": 0.004}
        
        # Claude 3 models
        "claude-3-opus-20240229": {"input": 0.015, "output": 0.075}
        "claude-3-sonnet-20240229": {"input": 0.003, "output": 0.015}
        "claude-3-haiku-20240307": {"input": 0.00025, "output": 0.00125}
        
        # Legacy Claude models
        "claude-2.1": {"input": 0.008, "output": 0.024}
        "claude-2.0": {"input": 0.008, "output": 0.024}
        "claude-instant-1.2": {"input": 0.0008, "output": 0.0024}
        
        # Generic fallback patterns
        "claude-3-5-sonnet": {"input": 0.003, "output": 0.015}
        "claude-3-5-haiku": {"input": 0.0008, "output": 0.004}
        "claude-3-opus": {"input": 0.015, "output": 0.075}
        "claude-3-sonnet": {"input": 0.003, "output": 0.015}
        "claude-3-haiku": {"input": 0.00025, "output": 0.00125}
        "claude-2": {"input": 0.008, "output": 0.024}
        "claude-instant": {"input": 0.0008, "output": 0.0024}
    description: "Calculate estimated cost based on current Anthropic pricing"

  # === DETECTION TRANSFORMS ===
  detect_instrumentor:
    function_type: "string_extraction"
    implementation: "detect_instrumentor_framework"
    parameters:
      attribute_patterns:
        openinference:
          - "llm.input_messages"
          - "llm.output_messages"
          - "llm.model_name"
        traceloop:
          - "gen_ai.request.model"
          - "gen_ai.completion"
          - "gen_ai.system"
        direct:
          - "anthropic.model"
          - "anthropic.messages"
          - "anthropic.response"
        langchain:
          - "langchain.llm.model_name"
          - "langchain.llm.provider"
        haystack:
          - "haystack.component.type"
          - "haystack.anthropic.model"
        generic:
          - "ai.model.provider"
          - "ai.model.name"
    description: "Detect which instrumentor framework is being used"
    
  static_anthropic:
    function_type: "static_value"
    implementation: "return_value"
    parameters:
      value: "anthropic"
    description: "Statically return 'anthropic' as the provider"

function_registry:
  string_extraction:
    - "extract_message_content_by_role"
    - "extract_first_non_empty"
    - "detect_instrumentor_framework"
    - "normalize_finish_reason"
    - "extract_parameter_value"
    - "extract_duration"
    - "extract_request_identifier"
  array_transformation:
    - "flatten_and_join"
    - "filter_by_role"
    - "extract_field_values_from_messages"
    - "deduplicate_array"
  numeric_calculation:
    - "sum_fields"
    - "average_fields"
    - "max_fields"
    - "min_fields"
    - "calculate_anthropic_cost"
  numeric_extraction:
    - "extract_parameter_value"
    - "extract_duration"
  object_transformation:
    - "merge_objects"
    - "filter_object_fields"
    - "rename_object_keys"
    - "flatten_nested_object"
  static_value:
    - "return_value"

validation:
  max_transforms_per_provider: 50
  required_parameters:
    - "function_type"
    - "implementation"
  allowed_function_types:
    - "string_extraction"
    - "array_transformation"
    - "numeric_calculation"
    - "numeric_extraction"
    - "object_transformation"
    - "static_value"
